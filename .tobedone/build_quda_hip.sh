#!/bin/bash
QUDA_HOME=/path/where/you/would/install/quda
MPI_HOME=/path/where/you/have/installed/mpi
EIGEN_HOME=/path/where/you/have/installed/eigen3
CXX_LD_LIB=$(dirname $(dirname $(which c++)))/lib64
LINKER="-L$CXX_LD_LIB -Wl,-rpath,$CXX_LD_LIB"
cmake .. \
  -DCMAKE_INSTALL_PREFIX=$QUDA_HOME \
  -DEIGEN_INCLUDE_DIR=$EIGEN_HOME/include/eigen3 \
  -DCMAKE_BUILD_TYPE=RELEASE \
  -DQUDA_BUILD_SHAREDLIB=ON \
  -DQUDA_TARGET_TYPE=HIP \
  -DQUDA_DIRAC_LAPLACE=ON \
  -DQUDA_DIRAC_COVDEV=ON \
  -DQUDA_DIRAC_WILSON=ON \
  -DQUDA_DIRAC_CLOVER=ON \
  -DQUDA_DIRAC_STAGGERED=ON \
  -DQUDA_DIRAC_DOMAIN_WALL=OFF \
  -DQUDA_DIRAC_TWISTED_MASS=OFF \
  -DQUDA_DIRAC_TWISTED_CLOVER=OFF \
  -DQUDA_CLOVER_DYNAMIC=ON \
  -DQUDA_CLOVER_RECONSTRUCT=ON \
  -DQUDA_CLOVER_CHOLESKY_PROMOTE=ON \
  -DQUDA_MULTIGRID=ON \
  -DQUDA_ENABLE_MMA=ON \
  -DQUDA_MULTIGRID_DSLASH_PROMOTE=ON \
  -DQUDA_MPI=ON \
  -DQUDA_QMP=OFF \
  -DQUDA_QIO=OFF \
  -DQUDA_ARPACK=OFF \
  -DQUDA_USE_EIGEN=ON \
  -DQUDA_DOWNLOAD_EIGEN=OFF \
  -DQUDA_DOWNLOAD_USQCD=OFF \
  -DQUDA_DOWNLOAD_NVSHMEM=OFF \
  -DQUDA_INTERFACE_QDP=ON \
  -DQUDA_INTERFACE_MILC=OFF \
  -DQUDA_INTERFACE_CPS=OFF \
  -DQUDA_INTERFACE_BQCD=OFF \
  -DQUDA_INTERFACE_TIFR=OFF \
  -DQUDA_INTERFACE_OPENQCD=OFF \
  -DQUDA_SPACK_BUILD=OFF \
  -DQUDA_BACKWARDS=OFF \
  -DQUDA_PRECISION=14 \
  -DQUDA_RECONSTRUCT=7 \
  -DQUDA_CXX_STANDARD=17 \
  -DQUDA_MAX_MULTI_BLAS_N=8 \
  -DCMAKE_C_COMPILER=$(which clang) \
  -DCMAKE_CXX_COMPILER=$(which clang++) \
  -DCMAKE_HIP_COMPILER=$(which dcc) \
  -DMPI_C_COMPILER=$(which mpicc) \
  -DMPI_CXX_COMPILER=$(which mpicxx) \
  -DCMAKE_C_FLAGS="-O3 -fPIC" \
  -DCMAKE_CXX_FLAGS="-O3 -fPIC" \
  -DCMAKE_EXE_LINKER_FLAGS=$LINKER \
  -DCMAKE_SHARED_LINKER_FLAGS=$LINKER
make -j$(expr $(nproc) / 3)
make install
